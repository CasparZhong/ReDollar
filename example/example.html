<!doctype html>
<html>

<head>
    <meta charset="utf-8" />

    <meta name='apple-touch-fullscreen' content='yes'>
    <meta name='format-detection' content='telephone=no'>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="KOK">

    <title>Test</title>

    <script type="text/javascript">
    </script>

    <script src="./tiny-game.js"></script>
    <script src="../src/Utils.js"></script>
    <script src="../src/Polyline.js"></script>
    <script src="../src/DollarOne.js"></script>

    <style type="text/css">
    </style>
    <script type="text/javascript">
    var game;

    function init() {
        initTouchEvent();
        game = new Game({
            width: 960,
            height: 640,
            onInit: function() {
                this.start();
            },
            beforeStart: function() {
                this.context.font = "20px Arial";
                this.scene = {
                    width: this.width,
                    height: this.height,

                    cooldown: 0,
                    update: function(timeStep, now) {
                        if (touched && this.cooldown <= 0) {
                            Points.push([touch.x, touch.y]);
                            this.cooldown = 2;
                        }
                        this.cooldown--;
                    },
                    render: function(context, timeStep, now) {
                        context.fillStyle = "#eeeeee";
                        context.fillRect(0, 0, this.width, this.height);
                        var tx = 300,
                            ty = 200;
                        var gestures = RD.$1.gesturePool;
                        // var names = Object.keys(gestures);
                        // names.forEach(function(n, idx) {
                        //     if (idx != 0) {
                        //         return
                        //     }
                        //     var g = gestures[n];
                        //     drawPoly(context, g.points, "black", tx, ty);
                        //     context.fillStyle = "red"
                        //     context.fillRect(tx - 2, ty - 2, 4, 4)
                        // })
                        if (Points.length > 0) {
                            if (Points.p) {
                                drawPoly(context, Points.p, "lightgreen", tx, ty);
                                context.fillStyle = "red";
                                context.fillText((Points.m || "*** NO ***") + "   " + Points.t, 10, 60);
                            }
                            var g = gestures[Points.m];
                            if (g) {
                                drawPoly(context, g.points, "red", tx, ty);
                            }
                            drawPoly(context, Points, "blue", 0, 0);
                        }
                    }
                }
            }
        });
        game.init();
    }

    var Points = [];
    var touched = false;
    var touch = {
        x: 0,
        y: 0,
    }
    var gi = 0;

    function initTouchEvent() {
        var useTouch="ontouchstart" in window;
        var start = "mousedown",
            move = "mousemove",
            end = "mouseup";

        if (useTouch) {
            start = "touchstart";
            move = "touchmove";
            end = "touchend";
        }

        document.addEventListener(start, function(event) {
            Points.length = 0;
            touched = true;
            touch.x = useTouch?event.changedTouches[0].pageX:event.pageX;
            touch.y = useTouch?event.changedTouches[0].pageY:event.pageY;
            event.preventDefault();
        }, true);

        document.addEventListener(move, function() {
            if (touched) {
                touch.x = useTouch?event.changedTouches[0].pageX:event.pageX;
                touch.y = useTouch?event.changedTouches[0].pageY:event.pageY;
            }
            event.preventDefault();
        }, true);

        document.addEventListener(end, function() {
            touched = false;
            if (Points.length > 10) {
                var t = Date.now();
                var m = RD.$1.recognize(Points, !true);
                console.log(gi+++":   " + m)
                var polyline = new RD.Polyline(Points);
                polyline.rotationInvariance = RD.$1.rotationInvariance;
                polyline.init();
                Points.p = polyline.points;
                Points.m = m;
                Points.t = Date.now() - t;
            }
            event.preventDefault();
        }, true);



        document.addEventListener("touchcancel", function() {
            // event.preventDefault();
        }, true);

    }

    function drawPoly(context, vertices, color, tx, ty) {
        tx = tx || 0;
        ty = ty || 0;
        if (color) {
            context.strokeStyle = color;
        }
        var vertexCount = vertices.length;
        var a = vertices[0];
        var first = a;
        context.beginPath();
        context.moveTo(a[0] + tx, a[1] + ty);
        for (var j = 1; j < vertexCount; j++) {
            var a = vertices[j];
            context.lineTo(a[0] + tx, a[1] + ty);
        }
        // context.lineTo(first[0], first[1]);
        context.stroke()
        context.closePath();

    }
    </script>


</head>

<body>

    <canvas id="canvas"></canvas>



</body>

</html>
